# DrivePower

Разработка ПО для зарядных станций электрокаров.

## Сервисы

- **CSMS (Go)** — минимальный OCPP 2.0.x сервер, который принимает WebSocket-подключения на `/ocpp/`, отвечает на `BootNotification`/`Heartbeat`, задаёт интервал пинга 10 секунд и закрывает сеанс после тестового heartbeat. HTTP-эндпоинт `/health` используется Docker Compose для проверки готовности.
- **station-emulator (Rust)** — эмулятор зарядной станции. Берёт настройки из переменных окружения (можно задать через `.env`), подключается к CSMS, проходит цикл `BootNotification → Heartbeat`, затем корректно завершает соединение после того как сервер отправит закрытие.

Go-сервис использует библиотеку `github.com/gorilla/websocket`, которая зафиксирована в `csms/third_party/github.com/gorilla/websocket` и подключается через директиву `replace` — благодаря этому сборка не обращается к интернету.

## Быстрый старт через Docker Compose

1. Установите Docker Desktop или Docker Engine + Docker Compose Plugin.
2. Склонируйте репозиторий и перейдите в его директорию.
3. Проверьте файл `emulator.env`: значение `CSMS_URL` должно указывать на `ws://csms:8080/ocpp` (без завершающего `/`). При необходимости отредактируйте остальные параметры станции.
4. Выполните сборку и запуск обоих сервисов одной командой:

   ```bash
   docker compose up --build
   ```

   Compose соберёт образы, запустит CSMS (порт 8080) и после успешного healthcheck стартует эмулятор.

5. Наблюдайте логи прямо в терминале Compose. В них будут видно:
   - на стороне CSMS — апгрейд WebSocket, входящие фреймы, ответы и сообщение о закрытии после heartbeat;
   - на стороне эмулятора — формирование адреса, отправка BootNotification/Heartbeat и обработка закрытия.

6. Для остановки сервисов нажмите `Ctrl+C` в терминале с Compose. Чтобы удалить контейнеры, выполните `docker compose down`.

## Запуск в VS Code

1. Откройте папку репозитория в VS Code.
2. В терминале №1 запустите `docker compose up --build`. Это поднимет оба сервиса и позволит смотреть объединённые логи прямо в окне редактора.
3. Если хотите разнести логи по отдельным окнам, после успешной сборки выполните `docker compose logs -f csms` и `docker compose logs -f emulator` в отдельных терминалах VS Code.
4. Для ручной перезагрузки эмулятора выполните `docker compose restart emulator`; чтобы перезапустить всё — `docker compose down && docker compose up`.

## Отладка без Docker

1. Убедитесь, что в системе установлен Go >= 1.21 и Rust toolchain.
2. В каталоге `csms` выполните `go build` (сборка использует локальную копию gorilla/websocket из `third_party`).
3. В каталоге `station-emulator` выполните `cargo run` (предварительно создайте `.env` или задайте переменные окружения).

## Решение конфликтов слияния

Если при слиянии веток GitHub показывает конфликты в `csms/go.mod`, `csms/go.sum` или `csms/main.go`, выполните локально:

```bash
git checkout <ваша-ветка>
git fetch origin
git merge origin/main
# вручную поправьте конфликтующие файлы, ориентируясь на текущие изменения в этом коммите
git add csms/go.mod csms/go.sum csms/main.go
git commit
git push
```

После разрешения конфликтов повторите операцию Merge Request.
